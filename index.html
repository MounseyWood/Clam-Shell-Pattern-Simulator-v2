<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêö</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manila Clam Pattern Generator</title>
    <style>
        :root {
            --ku-black: #1D1D1B;
            --ku-white: #FFFFFF;
            --ku-yellow: #FFF200;
            --ku-navy: #002b49;
            --ku-blue: #009cde;
            --ku-green: #78be20;
            --ku-orange: #e35205;
            --ku-gold: #ffb500;
            --ku-light-blue: #77c5d5;
            --ku-tan: #857550;
            --ku-purple: #9370DB;
        }
        
        * {
            box-sizing: border-box;
            font-family: Arial, Helvetica Neue, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: var(--ku-white);
            color: var(--ku-black);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1, h2, h3 {
            color: var(--ku-navy);
        }
        
        header {
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }
        
        .banner {
            background-color: var(--ku-navy);
            color: var(--ku-white);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .banner h1 {
            margin: 0;
            color: var(--ku-white);
        }
        
        .banner p {
            margin: 10px 0 0;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .controls {
            flex: 1;
            min-width: 300px;
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .canvas-container {
            flex: 2;
            min-width: 300px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #previewCanvas {
            width: 100%;
            max-width: 600px;
            height: auto;
            aspect-ratio: 1;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .hidden-canvas {
            display: none;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group h3 {
            margin-bottom: 10px;
            border-bottom: 2px solid var(--ku-blue);
            padding-bottom: 5px;
        }
        
        label {
            display: block;
            margin: 12px 0 6px;
            font-weight: 500;
        }
        
        input[type="range"] {
            width: 100%;
            margin-top: 5px;
        }
        
        .value-display {
            display: inline-block;
            width: 50px;
            text-align: right;
            margin-left: 10px;
        }
        
        select, input[type="color"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
        }
        
        button {
            background-color: var(--ku-blue);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s;
            width: 100%;
            margin-top: 5px;
        }
        
        button:hover {
            background-color: var(--ku-navy);
        }
        
        button.secondary {
            background-color: var(--ku-gold);
        }
        
        button.secondary:hover {
            background-color: var(--ku-orange);
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
        }
        
        .tooltip-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 18px;
            height: 18px;
            background-color: var(--ku-light-blue);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: var(--ku-navy);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Focus styles for better keyboard navigation */
        button:focus, input:focus, select:focus {
            outline: 3px solid var(--ku-yellow);
            outline-offset: 2px;
        }
        
        /* Additional CSS for new components */
        .color-pickers {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .color-picker {
            flex: 1;
        }

        .color-picker label {
            font-size: 14px;
            margin-bottom: 5px;
        }

        /* Animation controls */
        .animation-controls {
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin-top: 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 10px;
        }

        .animation-controls button {
            width: auto;
            margin-top: 0;
            padding: 8px 12px;
            font-size: 14px;
        }

        .animation-controls .play-pause {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--ku-blue);
            margin-right: 10px;
            padding: 0;
        }

        .animation-controls .play-pause:hover {
            background-color: var(--ku-navy);
        }

        .animation-controls .play-pause svg {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .animation-controls .speed-controls {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }

        .animation-controls .speed-controls button {
            margin: 0 2px;
            background-color: #ddd;
            color: #333;
        }

        .animation-controls .speed-controls button:hover,
        .animation-controls .speed-controls button.active {
            background-color: var(--ku-blue);
            color: white;
        }

        .animation-controls .timeline {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            margin: 0 10px;
        }

        .animation-controls .timeline-slider {
            width: 100%;
            margin: 0;
        }

        .animation-controls .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-top: 2px;
        }

        /* Age bands visualization */
        .age-bands {
            width: 100%;
            max-width: 600px;
            height: 20px;
            margin-top: 5px;
            display: flex;
            overflow: hidden;
            border-radius: 10px;
        }

        .age-band {
            height: 100%;
            flex-grow: 1;
            transition: background-color 0.3s;
        }

        /* Pattern blend visualization */
        .pattern-blend {
            width: 100%;
            max-width: 600px;
            margin-top: 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
        }

        .pattern-blend h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .blend-bars {
            display: flex;
            width: 100%;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .blend-bar {
            height: 100%;
            transition: width 0.5s;
        }

        .blend-bar.cellular {
            background-color: var(--ku-orange);
        }

        .blend-bar.wave {
            background-color: var(--ku-blue);
        }

        .blend-bar.growth {
            background-color: var(--ku-green);
        }

        .blend-bar.voronoi {
            background-color: var(--ku-purple);
        }

        .blend-bar.radial {
            background-color: var(--ku-gold);
        }

        .blend-labels {
            display: flex;
            flex-wrap: wrap;
            margin-top: 5px;
            font-size: 12px;
        }

        .blend-label {
            text-align: left;
            margin-right: 10px;
            margin-bottom: 5px;
        }

        /* Environment history graph */
        .environment-history {
            width: 100%;
            max-width: 600px;
            margin-top: 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
        }

        .environment-history h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .graph-container {
            position: relative;
            height: 100px;
            border-bottom: 1px solid #ccc;
            border-left: 1px solid #ccc;
            margin-top: 20px;
        }

        .graph-y-axis {
            position: absolute;
            left: -25px;
            top: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 10px;
        }

        .graph-line {
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: rgba(0,0,0,0.1);
        }

        .data-line {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .data-point {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            margin-left: -2.5px;
            margin-top: -2.5px;
        }

        .data-point.temperature {
            background-color: var(--ku-orange);
        }

        .data-point.salinity {
            background-color: var(--ku-blue);
        }

        .data-point.seasonal {
            background-color: var(--ku-green);
        }

        .data-point.microplastic {
            background-color: var(--ku-purple);
        }

        .data-point.acidification {
            background-color: var(--ku-tan);
        }

        .climate-trend {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-top: 2px dashed rgba(255, 0, 0, 0.4);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
        }

        .graph-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            margin-right: 10px;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 5px;
        }

        .legend-item:nth-child(1) .legend-color {
            background-color: var(--ku-orange);
        }

        .legend-item:nth-child(2) .legend-color {
            background-color: var(--ku-blue);
        }

        .legend-item:nth-child(3) .legend-color {
            background-color: var(--ku-green);
        }

        .legend-item:nth-child(4) .legend-color {
            background-color: var(--ku-purple);
        }

        .legend-item:nth-child(5) .legend-color {
            background-color: var(--ku-tan);
        }

        /* Growth information display */
        .growth-info {
            width: 100%;
            max-width: 600px;
            margin-top: 15px;
            background-color: var(--ku-light-blue);
            border-radius: 8px;
            padding: 15px;
        }

        .growth-info h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            color: var(--ku-navy);
        }

        .growth-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        .growth-event {
            padding: 8px;
            margin-top: 8px;
            background-color: rgba(255,255,255,0.7);
            border-radius: 4px;
            border-left: 4px solid var(--ku-green);
        }

        .growth-event.temperature {
            border-left-color: var(--ku-orange);
        }

        .growth-event.salinity {
            border-left-color: var(--ku-blue);
        }

        .growth-event.seasonal {
            border-left-color: var(--ku-green);
        }

        .growth-event.microplastic {
            border-left-color: var(--ku-purple);
        }

        .growth-event.acidification {
            border-left-color: var(--ku-tan);
        }

        .growth-event .timestamp {
            font-weight: bold;
            font-size: 12px;
            color: #666;
        }

        /* Climate badge */
        .climate-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            margin-left: 5px;
        }

        .climate-badge.pre-industrial {
            background-color: var(--ku-green);
        }

        .climate-badge.current {
            background-color: var(--ku-blue);
        }

        .climate-badge.near-future {
            background-color: var(--ku-orange);
        }

        .climate-badge.worst-case {
            background-color: #d9534f;
        }

        /* Pattern blend badges */
        .pattern-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            color: white;
            margin-right: 4px;
        }

        .pattern-badge.cellular {
            background-color: var(--ku-orange);
        }

        .pattern-badge.wave {
            background-color: var(--ku-blue);
        }

        .pattern-badge.growth {
            background-color: var(--ku-green);
        }

        .pattern-badge.voronoi {
            background-color: var(--ku-purple);
        }

        .pattern-badge.radial {
            background-color: var(--ku-gold);
        }

        /* Tabs system */
        .tabs {
            width: 100%;
            max-width: 600px;
            margin-top: 15px;
        }

        .tab-buttons {
            display: flex;
            overflow-x: auto;
        }

        .tab-button {
            padding: 8px 15px;
            background-color: #e0e0e0;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            color: #333;
            font-weight: 500;
            margin-right: 2px;
            width: auto;
        }

        .tab-button.active {
            background-color: var(--ku-navy);
            color: white;
        }

        .tab-content {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 0 5px 5px 5px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .tab-panel h3 {
            margin-top: 0;
            color: var(--ku-navy);
        }

        .tab-panel ul {
            padding-left: 20px;
        }

        .tab-panel li {
            margin-bottom: 8px;
        }

        /* Responsive design improvements */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .blend-labels {
                flex-direction: column;
            }

            .tab-buttons {
                flex-wrap: wrap;
            }

            .tab-button {
                margin-bottom: 4px;
            }
        }
        
        /* Fashion-specific styles for the fashion tab */
        .fashion-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .fashion-item {
            text-align: center;
            width: calc(50% - 10px);
            min-width: 120px;
        }

        .fashion-item img {
            width: 100%;
            height: auto;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .fashion-item p {
            margin: 5px 0;
            font-size: 12px;
        }

        /* UK map styling */
        .uk-map {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 15px auto;
            height: 360px;
            background-color: #f0f8ff;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .uk-region {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: var(--ku-orange);
            transform: translate(-50%, -50%);
        }

        .uk-region::after {
            content: attr(data-name);
            position: absolute;
            white-space: nowrap;
            left: 100%;
            top: 0;
            margin-left: 5px;
            font-size: 12px;
        }

        /* Improved tooltip for pattern types */
        .pattern-info-tooltip {
            display: inline-block;
            margin-left: 5px;
            cursor: help;
            position: relative;
        }

        .pattern-info-tooltip .tooltip-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 18px;
            height: 18px;
            background-color: var(--ku-light-blue);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
        }

        .pattern-info-tooltip .tooltip-content {
            visibility: hidden;
            width: 250px;
            background-color: var(--ku-navy);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 14px;
            line-height: 1.4;
        }

        .pattern-info-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        /* Pattern type badges */
        .pattern-type-samples {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .pattern-sample {
            width: calc(20% - 8px);
            min-width: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .pattern-sample .sample-box {
            width: 100%;
            aspect-ratio: 1;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
        }

        .pattern-sample:nth-child(1) .sample-box {
            background-color: var(--ku-orange);
            opacity: 0.8;
        }

        .pattern-sample:nth-child(2) .sample-box {
            background-color: var(--ku-blue);
            opacity: 0.8;
        }

        .pattern-sample:nth-child(3) .sample-box {
            background-color: var(--ku-green);
            opacity: 0.8;
        }

        .pattern-sample:nth-child(4) .sample-box {
            background-color: var(--ku-purple);
            opacity: 0.8;
        }

        .pattern-sample:nth-child(5) .sample-box {
            background-color: var(--ku-gold);
            opacity: 0.8;
        }

        .pattern-sample p {
            margin: 5px 0 0;
            font-size: 10px;
            text-align: center;
        }

        /* Better responsive layouts */
        @media (max-width: 768px) {
            .controls {
                min-width: 100%;
            }

            .canvas-container {
                min-width: 100%;
            }

            .pattern-sample {
                width: calc(33.33% - 7px);
            }

            .fashion-item {
                width: 100%;
            }

            .blend-labels {
                flex-direction: column;
            }

            .blend-label {
                margin-bottom: 3px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                animation: none !important;
            }
        }

        /* Improved focus styles for accessibility */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 3px solid var(--ku-yellow);
            outline-offset: 2px;
            position: relative;
            z-index: 1;
        }

        /* Screen reader only elements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Print styles */
        @media print {
            .controls, .animation-controls, .action-buttons {
                display: none;
            }

            .canvas-container {
                width: 100%;
            }

            .tab-content {
                padding: 0;
                border: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="banner">
                <h1>Manila Clam Pattern Generator</h1>
                <p>Create generative designs inspired by Venerupis philippinarum shell patterns found in UK waters</p>
            </div>
        </header>
        
        <main id="main">
            <div class="main-content">
                <div class="controls">
                    <div class="control-group">
                        <h3>Pattern Settings</h3>
                        
                        <label for="patternType">Initial Pattern Type</label>
                        <select id="patternType">
                            <option value="cellular">Cellular Automaton</option>
                            <option value="wave">Wave Interference</option>
                            <option value="growth">Growth Rings</option>
                            <option value="voronoi">Voronoi Texture</option>
                            <option value="radial">Radial Symmetry</option>
                        </select>
                        
                        <label for="patternBlending">Pattern Evolution
                            <span class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Controls how the pattern algorithm changes as the clam ages. Higher values create more dynamic evolution.</span>
                            </span>
                            <span class="value-display" id="patternBlendingValue">50</span>
                        </label>
                        <input type="range" id="patternBlending" min="0" max="100" value="50" aria-labelledby="patternBlendingValue">
                        
                        <label for="complexity">Pattern Complexity
                            <span class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Higher values create more intricate patterns with finer details.</span>
                            </span>
                            <span class="value-display" id="complexityValue">50</span>
                        </label>
                        <input type="range" id="complexity" min="10" max="100" value="50" aria-labelledby="complexityValue">
                        
                        <label for="symmetry">Bilateral Symmetry
                            <span class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Controls how symmetrical the pattern is across the central axis.</span>
                            </span>
                            <span class="value-display" id="symmetryValue">50</span>
                        </label>
                        <input type="range" id="symmetry" min="0" max="100" value="50" aria-labelledby="symmetryValue">
                    </div>
                    
                    <div class="control-group">
                        <h3>Climate Scenario</h3>
                        
                        <label for="climateScenario">UK Climate Scenario</label>
                        <select id="climateScenario">
                            <option value="pre-industrial">Pre-Industrial (Stable)</option>
                            <option value="current" selected>Current UK Waters</option>
                            <option value="near-future">Near-Future UK (2050)</option>
                            <option value="worst-case">Worst-Case UK (2100)</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <h3>Environmental Factors</h3>
                        
                        <label for="temperature">Starting Temperature (¬∞C)
                            <span class="value-display" id="temperatureValue">14</span>
                        </label>
                        <input type="range" id="temperature" min="5" max="28" value="14" aria-labelledby="temperatureValue">
                        
                        <label for="salinity">Starting Salinity (ppt)
                            <span class="value-display" id="salinityValue">32</span>
                        </label>
                        <input type="range" id="salinity" min="25" max="38" value="32" aria-labelledby="salinityValue">
                        
                        <label for="acidification">Starting Acidification (pH)
                            <span class="value-display" id="acidificationValue">0</span>
                        </label>
                        <input type="range" id="acidification" min="0" max="100" value="0" aria-labelledby="acidificationValue">
                        
                        <label for="microplastics">Microplastic Concentration
                            <span class="value-display" id="microplasticsValue">15</span>
                        </label>
                        <input type="range" id="microplastics" min="0" max="100" value="15" aria-labelledby="microplasticsValue">
                        
                        <label for="seasonalVariation">Seasonal Variation
                            <span class="value-display" id="seasonalVariationValue">40</span>
                        </label>
                        <input type="range" id="seasonalVariation" min="0" max="100" value="40" aria-labelledby="seasonalVariationValue">
                        
                        <label for="environmentalEvents">Environmental Events
                            <span class="value-display" id="environmentalEventsValue">3</span>
                        </label>
                        <input type="range" id="environmentalEvents" min="0" max="10" value="3" aria-labelledby="environmentalEventsValue">
                    </div>
                    
                    <div class="control-group">
                        <h3>Growth Settings</h3>
                        
                        <label for="growthYears">Growth Period (Years)
                            <span class="value-display" id="growthYearsValue">3</span>
                        </label>
                        <input type="range" id="growthYears" min="1" max="10" value="3" aria-labelledby="growthYearsValue">
                    </div>
                    
                    <div class="control-group">
                        <h3>Colour Settings</h3>
                        
                        <div class="color-pickers">
                            <div class="color-picker">
                                <label for="baseColor">Base</label>
                                <input type="color" id="baseColor" value="#e8d6b3">
                            </div>
                            <div class="color-picker">
                                <label for="accentColor">Accent</label>
                                <input type="color" id="accentColor" value="#6a4c3b">
                            </div>
                            <div class="color-picker">
                                <label for="microplasticColor">Microplastic</label>
                                <input type="color" id="microplasticColor" value="#9370DB">
                            </div>
                        </div>
                        
                        <label for="colorVariation">Colour Variation
                            <span class="value-display" id="colorVariationValue">30</span>
                        </label>
                        <input type="range" id="colorVariation" min="0" max="100" value="30" aria-labelledby="colorVariationValue">
                    </div>
                    
                    <div class="action-buttons">
                        <button id="generateButton" type="button">Start New Growth Simulation</button>
                        <button id="downloadButton" type="button" class="secondary">Download Pattern for Fashion</button>
                        <button id="resetButton" type="button">Reset Parameters</button>
                    </div>
                </div>
                
                <div class="canvas-container">
                    <canvas id="previewCanvas" width="600" height="600" aria-label="Manila clam shell pattern preview"></canvas>
                    
                    <div class="animation-controls">
                        <button id="playPauseButton" class="play-pause" aria-label="Play animation">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon>
                            </svg>
                        </button>
                        
                        <div class="timeline">
                            <input type="range" id="timelineSlider" class="timeline-slider" min="0" max="100" value="0" aria-label="Timeline slider">
                            <div class="time-display">
                                <span id="currentTimeDisplay">0y 0m</span>
                                <span id="totalTimeDisplay">3y 0m</span>
                            </div>
                        </div>
                        
                        <div class="speed-controls">
                            <button id="speedSlow" class="speed-btn" data-speed="0.5" aria-label="Half speed">0.5√ó</button>
                            <button id="speedNormal" class="speed-btn active" data-speed="1" aria-label="Normal speed">1√ó</button>
                            <button id="speedFast" class="speed-btn" data-speed="2" aria-label="Double speed">2√ó</button>
                        </div>
                    </div>
                    
                    <div id="ageBands" class="age-bands" aria-label="Age bands visualization"></div>
                    
                    <div class="pattern-blend">
                        <h3>Pattern Algorithm Blend</h3>
                        <div class="blend-bars" id="blendBars">
                            <div class="blend-bar cellular" style="width: 100%;"></div>
                            <div class="blend-bar wave" style="width: 0%;"></div>
                            <div class="blend-bar growth" style="width: 0%;"></div>
                            <div class="blend-bar voronoi" style="width: 0%;"></div>
                            <div class="blend-bar radial" style="width: 0%;"></div>
                        </div>
                        <div class="blend-labels">
                            <div class="blend-label" id="cellularBlendLabel">Cellular: 100%</div>
                            <div class="blend-label" id="waveBlendLabel">Wave: 0%</div>
                            <div class="blend-label" id="growthBlendLabel">Growth: 0%</div>
                            <div class="blend-label" id="voronoiBlendLabel">Voronoi: 0%</div>
                            <div class="blend-label" id="radialBlendLabel">Radial: 0%</div>
                        </div>
                    </div>

                    <!-- Environment panels -->
                    <div class="environment-history">
                        <h3>Environmental History</h3>
                        
                        <div class="graph-container" id="environmentGraph">
                            <div class="graph-y-axis">
                                <span>High</span>
                                <span>Med</span>
                                <span>Low</span>
                            </div>
                            
                            <div class="graph-line" style="top: 0%;"></div>
                            <div class="graph-line" style="top: 50%;"></div>
                            <div class="graph-line" style="top: 100%;"></div>
                            
                            <div class="climate-trend" id="climateTrend"></div>
                            <div class="data-line" id="temperatureLine"></div>
                            <div class="data-line" id="salinityLine"></div>
                            <div class="data-line" id="seasonalLine"></div>
                            <div class="data-line" id="microplasticLine"></div>
                            <div class="data-line" id="acidificationLine"></div>
                        </div>
                        
                        <div class="graph-legend">
                            <div class="legend-item">
                                <div class="legend-color"></div>
                                <span>Temperature</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color"></div>
                                <span>Salinity</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color"></div>
                                <span>Seasonal</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color"></div>
                                <span>Microplastics</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color"></div>
                                <span>Acidification</span>
                            </div>
                        </div>
                    </div>

                    <div class="growth-info" id="growthInfo">
                        <h3>Growth Information</h3>
                        <p>Ready to start growth simulation. Press the play button to begin.</p>
                        <!-- Growth events will be added here dynamically -->
                    </div>

                    <div class="tabs">
                        <div class="tab-buttons">
                            <button class="tab-button active" data-tab="about" aria-selected="true" id="about-tab" aria-controls="aboutTab">About Manila Clams</button>
                            <button class="tab-button" data-tab="uk" aria-selected="false" id="uk-tab" aria-controls="ukTab">UK Habitats</button>
                            <button class="tab-button" data-tab="climate" aria-selected="false" id="climate-tab" aria-controls="climateTab">Climate Effects</button>
                            <button class="tab-button" data-tab="patterns" aria-selected="false" id="patterns-tab" aria-controls="patternsTab">Shell Patterns</button>
                            <button class="tab-button" data-tab="fashion" aria-selected="false" id="fashion-tab" aria-controls="fashionTab">Fashion Application</button>
                        </div>
                        
                        <div class="tab-content">
                            <div class="tab-panel about active" id="aboutTab" role="tabpanel" aria-labelledby="about-tab">
                                <h3>About Manila Clam Patterns</h3>
                                <p>The Manila clam (Venerupis philippinarum, also known as Ruditapes philippinarum) creates its shell pattern by depositing calcium carbonate and proteins in layers as it grows. Each new row in the pattern builds upon the previous one, with environmental factors like water temperature, salinity, and food availability influencing the appearance.</p>
                                <p>This simulator mimics that process, building the pattern line by line over time. You can watch the pattern develop, see how environmental changes affect growth, and observe how the shell responds to conditions just like a real clam would in nature.</p>
                            </div>
                            
                            <div class="tab-panel uk" id="ukTab" role="tabpanel" aria-labelledby="uk-tab">
                                <h3>Manila Clams in UK Waters</h3>
                                <p>In the UK, Manila clams were deliberately introduced for aquaculture in the 1980s. They have established wild populations primarily in southern England, particularly in:</p>
                                <ul>
                                    <li><strong>Poole Harbour, Dorset</strong> - Extensive wild populations</li>
                                    <li><strong>Southampton Water</strong> - Established beds</li>
                                    <li><strong>The Solent & Portsmouth Harbour</strong> - Growing populations</li>
                                    <li><strong>Essex & Thames Estuary</strong> - Multiple colonies</li>
                                    <li><strong>Coastal Wales</strong> - Smaller emerging populations</li>
                                </ul>
                                <p>They prefer sheltered estuaries and harbours with sandy/muddy substrates. UK specimens typically grow to 4-6cm in diameter and form shells with distinctive patterning varying from sandy yellow to deep brown with dark zigzag markings.</p>
                                <p>As non-native species, their spread is closely monitored, though they are considered naturalized and commercially important for UK shellfish industry.</p>
                            </div>
                            
                            <div class="tab-panel climate" id="climateTab" role="tabpanel" aria-labelledby="climate-tab">
                                <h3>Climate Change Effects in UK Waters</h3>
                                <p>Research shows Manila clams in UK waters are affected by climate change:</p>
                                <ul>
                                    <li><strong>Ocean Acidification:</strong> UK coastal waters are experiencing decreasing pH, reducing calcium carbonate availability and resulting in thinner, more irregular shell patterns.</li>
                                    <li><strong>Rising Water Temperatures:</strong> Average UK sea surface temperatures have risen by about 0.8¬∞C since 1980, affecting clam metabolism and growth patterns.</li>
                                    <li><strong>Changing Rainfall Patterns:</strong> More intense rainfall events in the UK alter estuarine salinity levels, creating stress bands in shell growth.</li>
                                    <li><strong>Increased Storm Frequency:</strong> More severe UK winter storms disrupt feeding and growth, visible as interruptions in shell patterning.</li>
                                </ul>
                                <p>The simulation includes four climate scenarios to demonstrate these effects on shell growth and pattern formation over time in UK conditions.</p>
                            </div>
                            
                            <div class="tab-panel patterns" id="patternsTab" role="tabpanel" aria-labelledby="patterns-tab">
                                <h3>Shell Pattern Formation</h3>
                                <p>Manila clam shells display several distinctive pattern characteristics:</p>
                                <ul>
                                    <li><strong>Radial Symmetry</strong> - Patterns radiate from the hinge (umbo) with bilateral symmetry</li>
                                    <li><strong>Concentric Growth Rings</strong> - Arched bands following the shell's growth over time</li>
                                    <li><strong>Reticulated Texture</strong> - Fine broken lines or mesh-like patterns</li>
                                    <li><strong>Pigment Clusters</strong> - Random organic-looking spots or speckles</li>
                                </ul>
                                <p>As clams age, their shell formation processes adapt:</p>
                                <ul>
                                    <li>Young clams show simpler patterns focused on rapid growth</li>
                                    <li>Mature clams develop more complex patterns with finer details</li>
                                    <li>The mantle cells responsible for shell secretion change behavior based on environmental stress</li>
                                </ul>
                                <p>This simulator blends between multiple different pattern algorithms as the clam ages, creating more realistic and varied shell patterns.</p>
                            </div>
                            
                            <div class="tab-panel fashion" id="fashionTab" role="tabpanel" aria-labelledby="fashion-tab">
                                <h3>Fashion Application</h3>
                                <p>The patterns generated here can be downloaded and used in fashion design applications. Biomimicry - drawing inspiration from nature's designs - is a powerful approach to sustainable fashion:</p>
                                <ul>
                                    <li><strong>Textile Prints</strong> - Use these organic patterns for fabric designs that celebrate natural forms</li>
                                    <li><strong>Garment Construction</strong> - The concentric growth patterns can inspire layered or paneled garment designs</li>
                                    <li><strong>Color Palettes</strong> - Natural shell gradients provide harmonious color combinations</li>
                                    <li><strong>Sustainable Storytelling</strong> - Connect designs to environmental awareness through nature-inspired patterns</li>
                                </ul>
                                <p>The "Download Pattern for Fashion" button provides a high-resolution PNG that can be imported into fashion design software or digital textile printing systems.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <canvas id="fullResCanvas" width="4096" height="4096" class="hidden-canvas"></canvas>
    <div id="statusUpdate" class="sr-status" aria-live="polite"></div>

    <script>
        // DOM elements
        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');
        const fullResCanvas = document.getElementById('fullResCanvas');
        const fullResCtx = fullResCanvas.getContext('2d');
        const generateButton = document.getElementById('generateButton');
        const downloadButton = document.getElementById('downloadButton');
        const resetButton = document.getElementById('resetButton');
        const statusUpdate = document.getElementById('statusUpdate');

        // Animation controls
        const playPauseButton = document.getElementById('playPauseButton');
        const timelineSlider = document.getElementById('timelineSlider');
        const currentTimeDisplay = document.getElementById('currentTimeDisplay');
        const totalTimeDisplay = document.getElementById('totalTimeDisplay');
        const speedButtons = document.querySelectorAll('.speed-btn');
        const ageBands = document.getElementById('ageBands');

        // Pattern blend visualization
        const blendBars = document.getElementById('blendBars');
        const cellularBlendLabel = document.getElementById('cellularBlendLabel');
        const waveBlendLabel = document.getElementById('waveBlendLabel');
        const growthBlendLabel = document.getElementById('growthBlendLabel');
        const voronoiBlendLabel = document.getElementById('voronoiBlendLabel');
        const radialBlendLabel = document.getElementById('radialBlendLabel');

        // Environment history
        const environmentGraph = document.getElementById('environmentGraph');
        const temperatureLine = document.getElementById('temperatureLine');
        const salinityLine = document.getElementById('salinityLine');
        const seasonalLine = document.getElementById('seasonalLine');
        const microplasticLine = document.getElementById('microplasticLine');
        const acidificationLine = document.getElementById('acidificationLine');
        const climateTrend = document.getElementById('climateTrend');

        // Climate scenario
        const climateScenarioSelect = document.getElementById('climateScenario');

        // Growth info
        const growthInfo = document.getElementById('growthInfo');

        // Tab system
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanels = document.querySelectorAll('.tab-panel');

        // Input elements and value displays
        const patternTypeSelect = document.getElementById('patternType');
        const patternBlendingInput = document.getElementById('patternBlending');
        const patternBlendingValue = document.getElementById('patternBlendingValue');
        const complexityInput = document.getElementById('complexity');
        const complexityValue = document.getElementById('complexityValue');
        const symmetryInput = document.getElementById('symmetry');
        const symmetryValue = document.getElementById('symmetryValue');
        const temperatureInput = document.getElementById('temperature');
        const temperatureValue = document.getElementById('temperatureValue');
        const salinityInput = document.getElementById('salinity');
        const salinityValue = document.getElementById('salinityValue');
        const acidificationInput = document.getElementById('acidification');
        const acidificationValue = document.getElementById('acidificationValue');
        const microplasticsInput = document.getElementById('microplastics');
        const microplasticsValue = document.getElementById('microplasticsValue');
        const seasonalVariationInput = document.getElementById('seasonalVariation');
        const seasonalVariationValue = document.getElementById('seasonalVariationValue');
        const environmentalEventsInput = document.getElementById('environmentalEvents');
        const environmentalEventsValue = document.getElementById('environmentalEventsValue');
        const growthYearsInput = document.getElementById('growthYears');
        const growthYearsValue = document.getElementById('growthYearsValue');
        const baseColorInput = document.getElementById('baseColor');
        const accentColorInput = document.getElementById('accentColor');
        const microplasticColorInput = document.getElementById('microplasticColor');
        const colorVariationInput = document.getElementById('colorVariation');
        const colorVariationValue = document.getElementById('colorVariationValue');

        // Animation state
        let animationState = {
            isPlaying: false,
            speed: 1,
            currentRow: 0,
            totalRows: 0,
            startTime: 0,
            currentTime: 0,
            animationFrameId: null,
            growthYears: 3,
            monthsPerRow: 0,
            environmentalHistory: [],
            growthEvents: [],
            acidificationEvents: [],
            microplasticEvents: [],
            rowsCompleted: 0,
            patternBlend: { cellular: 1, wave: 0, growth: 0, voronoi: 0, radial: 0 },
            climateScenario: 'current',
            symmetryFactor: 0.5 // Control for bilateral symmetry
        };

        // Event listeners for range inputs to update displayed values
        patternBlendingInput.addEventListener('input', () => {
            patternBlendingValue.textContent = patternBlendingInput.value;
        });

        complexityInput.addEventListener('input', () => {
            complexityValue.textContent = complexityInput.value;
        });

        symmetryInput.addEventListener('input', () => {
            symmetryValue.textContent = symmetryInput.value;
        });

        temperatureInput.addEventListener('input', () => {
            temperatureValue.textContent = temperatureInput.value;
        });

        salinityInput.addEventListener('input', () => {
            salinityValue.textContent = salinityInput.value;
        });

        acidificationInput.addEventListener('input', () => {
            acidificationValue.textContent = acidificationInput.value;
        });

        microplasticsInput.addEventListener('input', () => {
            microplasticsValue.textContent = microplasticsInput.value;
        });

        seasonalVariationInput.addEventListener('input', () => {
            seasonalVariationValue.textContent = seasonalVariationInput.value;
        });

        environmentalEventsInput.addEventListener('input', () => {
            environmentalEventsValue.textContent = environmentalEventsInput.value;
        });

        growthYearsInput.addEventListener('input', () => {
            growthYearsValue.textContent = growthYearsInput.value;
            totalTimeDisplay.textContent = `${growthYearsInput.value}y 0m`;
        });

        colorVariationInput.addEventListener('input', () => {
            colorVariationValue.textContent = colorVariationInput.value;
        });

        // Climate scenario change event
        climateScenarioSelect.addEventListener('change', () => {
            // Update environmental parameters based on climate scenario
            updateClimateScenarioParameters();
        });

        // Button event listeners
        generateButton.addEventListener('click', startNewSimulation);
        downloadButton.addEventListener('click', downloadFullResolution);
        resetButton.addEventListener('click', resetParameters);

        // Animation control event listeners
        playPauseButton.addEventListener('click', togglePlayPause);
        timelineSlider.addEventListener('input', scrubTimeline);

        // Tab system event listeners
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons and panels
                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                });
                tabPanels.forEach(panel => panel.classList.remove('active'));
                
                // Add active class to clicked button
                button.classList.add('active');
                button.setAttribute('aria-selected', 'true');
                
                // Show corresponding panel
                const tabId = button.getAttribute('data-tab');
                document.getElementById(`${tabId}Tab`).classList.add('active');
            });
        });

        // Speed button event listeners
        speedButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons
                speedButtons.forEach(b => b.classList.remove('active'));
                
                // Add active class to clicked button
                button.classList.add('active');
                
                // Set animation speed
                animationState.speed = parseFloat(button.dataset.speed);
            });
        });

        // Generate pattern when page loads
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializeSimulation, 100);
        });

        // Update climate scenario parameters for UK waters
        function updateClimateScenarioParameters() {
            const scenario = climateScenarioSelect.value;
            animationState.climateScenario = scenario;
            
            // Adjust parameters based on climate scenario - UK specific
            switch (scenario) {
                case 'pre-industrial':
                    // Pre-industrial: minimal pollution, stable climate
                    microplasticsInput.value = 0;
                    microplasticsValue.textContent = 0;
                    acidificationInput.value = 0;
                    acidificationValue.textContent = 0;
                    seasonalVariationInput.value = 30;
                    seasonalVariationValue.textContent = 30;
                    temperatureInput.value = 13;
                    temperatureValue.textContent = 13;
                    break;
                    
                case 'current':
                    // Current: moderate pollution, UK conditions
                    microplasticsInput.value = 15;
                    microplasticsValue.textContent = 15;
                    acidificationInput.value = 20;
                    acidificationValue.textContent = 20;
                    seasonalVariationInput.value = 40;
                    seasonalVariationValue.textContent = 40;
                    temperatureInput.value = 14;
                    temperatureValue.textContent = 14;
                    break;
                    
                case 'near-future':
                    // Near-future UK: higher pollution, more variability
                    microplasticsInput.value = 45;
                    microplasticsValue.textContent = 45;
                    acidificationInput.value = 50;
                    acidificationValue.textContent = 50;
                    seasonalVariationInput.value = 65;
                    seasonalVariationValue.textContent = 65;
                    temperatureInput.value = 16;
                    temperatureValue.textContent = 16;
                    break;
                    
                case 'worst-case':
                    // Worst-case UK 2100: severe pollution, extreme variability
                    microplasticsInput.value = 75;
                    microplasticsValue.textContent = 75;
                    acidificationInput.value = 80;
                    acidificationValue.textContent = 80;
                    seasonalVariationInput.value = 85;
                    seasonalVariationValue.textContent = 85;
                    temperatureInput.value = 19;
                    temperatureValue.textContent = 19;
                    break;
            }
            
            // Update status with accessibility in mind
            statusUpdate.textContent = `Climate scenario updated to ${formatClimateScenario(scenario)}`;
        }

        // Reset parameters to default values - UK specific
        function resetParameters() {
            patternTypeSelect.value = 'cellular';
            patternBlendingInput.value = 50;
            patternBlendingValue.textContent = 50;
            complexityInput.value = 50;
            complexityValue.textContent = 50;
            symmetryInput.value = 50;
            symmetryValue.textContent = 50;
            climateScenarioSelect.value = 'current';
            temperatureInput.value = 14;
            temperatureValue.textContent = 14;
            salinityInput.value = 32;
            salinityValue.textContent = 32;
            acidificationInput.value = 20;
            acidificationValue.textContent = 20;
            microplasticsInput.value = 15;
            microplasticsValue.textContent = 15;
            seasonalVariationInput.value = 40;
            seasonalVariationValue.textContent = 40;
            environmentalEventsInput.value = 3;
            environmentalEventsValue.textContent = 3;
            growthYearsInput.value = 3;
            growthYearsValue.textContent = 3;
            baseColorInput.value = '#e8d6b3';
            accentColorInput.value = '#6a4c3b';
            microplasticColorInput.value = '#9370DB';
            colorVariationInput.value = 30;
            colorVariationValue.textContent = 30;
            
            statusUpdate.textContent = "Parameters reset to UK-specific default values";
            startNewSimulation();
        }

        // Format climate scenario for display
        function formatClimateScenario(scenario) {
            switch (scenario) {
                case 'pre-industrial':
                    return 'Pre-Industrial';
                case 'current':
                    return 'Current UK Waters';
                case 'near-future':
                    return 'Near-Future UK (2050)';
                case 'worst-case':
                    return 'Worst-Case UK (2100)';
                default:
                    return scenario;
            }
        }

        // Initialize the simulation
        function initializeSimulation() {
            // Clear animation if already running
            if (animationState.animationFrameId) {
                cancelAnimationFrame(animationState.animationFrameId);
            }
            
            // Set up initial state
            animationState.isPlaying = false;
            animationState.currentRow = 0;
            animationState.totalRows = previewCanvas.height;
            animationState.growthYears = parseInt(growthYearsInput.value);
            animationState.monthsPerRow = (animationState.growthYears * 12) / animationState.totalRows;
            animationState.environmentalHistory = [];
            animationState.growthEvents = [];
            animationState.acidificationEvents = [];
            animationState.microplasticEvents = [];
            animationState.rowsCompleted = 0;
            animationState.climateScenario = climateScenarioSelect.value;
            animationState.symmetryFactor = parseInt(symmetryInput.value) / 100;
            
            // Initialize pattern blend based on selected pattern type
            initializePatternBlend();
            
            // Update UI
            updatePlayPauseButton();
            timelineSlider.value = 0;
            timelineSlider.max = animationState.totalRows;
            currentTimeDisplay.textContent = formatTimeDisplay(0);
            totalTimeDisplay.textContent = formatTimeDisplay(animationState.totalRows);
            
            // Clear canvas
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            
            // Initialize pattern generation
            initializePatternGeneration();
            
            // Generate environmental events - UK specific
            generateUKEnvironmentalEvents();
            
            // Generate acidification events
            generateAcidificationEvents();
            
            // Generate microplastic events
            generateMicroplasticEvents();
            
            // Create age bands
            createAgeBands();
            
            // Update growth info
            updateGrowthInfo(0);
            
            // Update pattern blend visualization
            updatePatternBlendVisualization(0);
            
            // Draw first row
            drawNextRow();
            
            // Update environment graph
            updateEnvironmentGraph();
        }

        // Generate UK-specific environmental events
        function generateUKEnvironmentalEvents() {
            const eventCount = parseInt(environmentalEventsInput.value);
            const totalRows = animationState.totalRows;
            const climateScenario = animationState.climateScenario;
            
            // Clear existing events
            animationState.growthEvents = [];
            
            // If no events, return
            if (eventCount === 0) return;
            
            // UK-specific events by scenario
            let ukEventTypes = [];
            switch (climateScenario) {
                case 'pre-industrial':
                    ukEventTypes = ['mild_temperature', 'mild_storm', 'mild_salinity'];
                    break;
                case 'current':
                    ukEventTypes = ['temperature', 'storm', 'algal_bloom', 'salinity', 'pollution'];
                    break;
                case 'near-future':
                    ukEventTypes = ['temperature', 'severe_storm', 'algal_bloom', 'salinity', 'pollution'];
                    break;
                case 'worst-case':
                    ukEventTypes = ['extreme_temperature', 'severe_storm', 'toxic_bloom', 'extreme_salinity', 'pollution'];
                    break;
            }
            
            // Generate random events
            for (let i = 0; i < eventCount; i++) {
                // Random event type from scenario-appropriate list
                const type = ukEventTypes[Math.floor(Math.random() * ukEventTypes.length)];
                
                // Random event timing and duration
                const startRow = Math.floor(Math.random() * (totalRows * 0.9)); // Start in first 90% of rows
                const duration = Math.floor((totalRows * 0.05) + (Math.random() * totalRows * 0.15)); // 5-20% of total rows
                const endRow = Math.min(startRow + duration, totalRows - 1);
                const peakRow = startRow + Math.floor(duration / 2); // Peak in the middle
                
                // Random intensity (0.2 to 1.0)
                const intensity = 0.2 + (Math.random() * 0.8);
                
                // Create event object
                const event = {
                    type,
                    startRow,
                    endRow,
                    peakRow,
                    intensity,
                    name: getUKEventName(type, intensity),
                    description: getUKEventDescription(type, intensity, animationState.climateScenario)
                };
                
                // Add to events array
                animationState.growthEvents.push(event);
            }
            
            // Sort events by start row
            animationState.growthEvents.sort((a, b) => a.startRow - b.startRow);
        }

        // Get UK-specific event name based on type and intensity
        function getUKEventName(type, intensity) {
            const intensityLabel = intensity < 0.4 ? 'Mild' : intensity < 0.7 ? 'Moderate' : 'Severe';
            
            switch (type) {
                case 'mild_temperature':
                    return `${intensityLabel} Seasonal Warming`;
                case 'temperature':
                    return `${intensityLabel} Temperature Change`;
                case 'extreme_temperature':
                    return `Extreme Heatwave`;
                case 'mild_storm':
                    return `${intensityLabel} Weather Event`;
                case 'storm':
                    return `${intensityLabel} UK Storm`;
                case 'severe_storm':
                    return `Named Storm System`;
                case 'mild_salinity':
                    return `${intensityLabel} Rainfall Event`;
                case 'salinity':
                    return `${intensityLabel} Salinity Shift`;
                case 'extreme_salinity':
                    return `Extreme Freshwater Input`;
                case 'algal_bloom':
                    return `${intensityLabel} Algal Bloom`;
                case 'toxic_bloom':
                    return `Toxic Algal Bloom`;
                case 'pollution':
                    return `${intensityLabel} Pollution Event`;
                default:
                    return 'Environmental Event';
            }
        }

        // Get UK-specific event description based on type and intensity
        function getUKEventDescription(type, intensity, climateScenario) {
            let prefix = '';
            
            // Add climate scenario context
            if (climateScenario === 'near-future' && (type.includes('temperature') || type.includes('storm'))) {
                prefix = 'As projected for 2050s UK coastal waters, a ';
            } else if (climateScenario === 'worst-case' && (type.includes('extreme') || type.includes('toxic'))) {
                prefix = 'In this extreme climate scenario for UK waters by 2100, a ';
            }
            
            switch (type) {
                case 'mild_temperature':
                    return 'Typical UK seasonal warming affects shell growth rate slightly.';
                
                case 'temperature':
                    if (intensity < 0.4) {
                        return prefix + 'milder than average summer period affects shell growth rate.';
                    } else if (intensity < 0.7) {
                        return prefix + 'significant warming event in UK waters accelerates shell growth and alters pattern formation.';
                    } else {
                        return prefix + 'UK marine heatwave significantly increases metabolism and alters growth patterns.';
                    }
                
                case 'extreme_temperature':
                    return prefix + 'prolonged extreme marine heatwave causes physiological stress and disrupts normal shell formation.';
                
                case 'mild_storm':
                    return 'Typical UK weather pattern brings rainfall and slight temperature changes.';
                
                case 'storm':
                    if (intensity < 0.4) {
                        return 'Minor UK storm brings fresh water runoff and temperature drop.';
                    } else if (intensity < 0.7) {
                        return 'Significant autumn/winter storm disrupts normal growth with temperature and salinity changes typical of UK coastal waters.';
                    } else {
                        return 'Major storm event brings substantial freshwater input to the estuary, creating a distinctive growth interruption.';
                    }
                
                case 'severe_storm':
                    return prefix + 'named storm system causes major disruption to coastal habitats with significant freshwater influx and sediment resuspension.';
                
                case 'mild_salinity':
                    return 'Normal seasonal rainfall affects estuarine salinity levels.';
                
                case 'salinity':
                    if (intensity < 0.4) {
                        return 'A slight change in salinity due to rainfall affects shell mineralization.';
                    } else if (intensity < 0.7) {
                        return 'Moderate salinity change from prolonged precipitation alters the shell pattern definition.';
                    } else {
                        return 'Dramatic salinity shift from flooding causes stress and creates distinct pattern banding.';
                    }
                
                case 'extreme_salinity':
                    return prefix + 'extreme flooding event dramatically lowers salinity in the estuary, severely stressing the clam and creating a distinct stress band in the shell.';
                
                case 'algal_bloom':
                    if (intensity < 0.5) {
                        return 'Seasonal algal bloom provides abundant food, increasing growth rate temporarily.';
                    } else {
                        return 'Large algal bloom depletes oxygen when it dies off, temporarily slowing growth and affecting shell density.';
                    }
                
                case 'toxic_bloom':
                    return prefix + 'harmful algal bloom produces toxins that disrupt the shell formation process, creating distinctive pattern abnormalities.';
                
                case 'pollution':
                    if (intensity < 0.4) {
                        return 'Minor pollution event from coastal runoff affects shell coloration slightly.';
                    } else if (intensity < 0.7) {
                        return 'Moderate pollution from agricultural or urban runoff disrupts normal shell formation.';
                    } else {
                        return 'Significant pollution event causes visible disruption to shell growth and pattern formation.';
                    }
                
                default:
                    return 'Environmental conditions in UK waters changed, affecting shell growth.';
            }
        }

        // Generate acidification events - UK specific
        function generateAcidificationEvents() {
            const climateScenario = animationState.climateScenario;
            const totalRows = animationState.totalRows;
            
            // Clear existing events
            animationState.acidificationEvents = [];
            
            // Number of events depends on climate scenario
            let eventCount = 0;
            switch (climateScenario) {
                case 'pre-industrial':
                    eventCount = 0; // No acidification events
                    break;
                case 'current':
                    eventCount = 1; // Occasional acidification event in UK waters
                    break;
                case 'near-future':
                    eventCount = 2; // More frequent acidification events by 2050
                    break;
                case 'worst-case':
                    eventCount = 4; // Severe and frequent acidification events by 2100
                    break;
            }
            
            // If no events, return
            if (eventCount === 0) return;
            
            // Generate acidification events
            for (let i = 0; i < eventCount; i++) {
                // Random event timing and duration
                const startRow = Math.floor(Math.random() * (totalRows * 0.9)); // Start in first 90% of rows
                const duration = Math.floor((totalRows * 0.08) + (Math.random() * totalRows * 0.15)); // 8-23% of total rows
                const endRow = Math.min(startRow + duration, totalRows - 1);
                const peakRow = startRow + Math.floor(duration / 2); // Peak in the middle
                
                // Intensity depends on climate scenario
                let baseIntensity = 0;
                switch (climateScenario) {
                    case 'current':
                        baseIntensity = 0.2 + (Math.random() * 0.2); // 0.2-0.4
                        break;
                    case 'near-future':
                        baseIntensity = 0.4 + (Math.random() * 0.3); // 0.4-0.7
                        break;
                    case 'worst-case':
                        baseIntensity = 0.6 + (Math.random() * 0.4); // 0.6-1.0
                        break;
                }
                
                // Create event object with UK-specific descriptions
                const event = {
                    type: 'acidification',
                    startRow,
                    endRow,
                    peakRow,
                    intensity: baseIntensity,
                    name: `${baseIntensity < 0.4 ? 'Mild' : baseIntensity < 0.7 ? 'Moderate' : 'Severe'} UK Waters Acidification`,
                    description: getUKAcidificationDescription(baseIntensity, climateScenario)
                };
                
                // Add to events array
                animationState.acidificationEvents.push(event);
            }
            
            // Sort events by start row
            animationState.acidificationEvents.sort((a, b) => a.startRow - b.startRow);
        }

        // Get UK-specific acidification event description
        function getUKAcidificationDescription(intensity, climateScenario) {
            let prefix = '';
            
            // Add climate scenario context for near-future and worst-case
            if (climateScenario === 'near-future') {
                prefix = 'Due to projected UK coastal water pH changes by 2050, ';
            } else if (climateScenario === 'worst-case') {
                prefix = 'In this extreme acidification scenario for UK waters by 2100, ';
            }
            
            if (intensity < 0.4) {
                return prefix + 'mild pH decrease causes slight shell thinning in UK waters.';
            } else if (intensity < 0.7) {
                return prefix + 'moderate acidification in UK coastal waters disrupts calcium carbonate deposition, causing pattern irregularities.';
            } else {
                return prefix + 'severe acidification event significantly weakens shell structure, creating visible disruptions typical of extreme climate scenarios.';
            }
        }

        // Generate microplastic events - UK specific
        function generateMicroplasticEvents() {
            const climateScenario = animationState.climateScenario;
            const totalRows = animationState.totalRows;
            
            // Clear existing events
            animationState.microplasticEvents = [];
            
            // Number of events depends on climate scenario
            let eventCount = 0;
            switch (climateScenario) {
                case 'pre-industrial':
                    eventCount = 0; // No microplastic events
                    break;
                case 'current':
                    eventCount = 2; // Current UK coastal pollution levels
                    break;
                case 'near-future':
                    eventCount = 3; // Near-future projections for UK waters
                    break;
                case 'worst-case':
                    eventCount = 5; // Worst-case scenario for UK waters
                    break;
            }
            
            // If no events, return
            if (eventCount === 0) return;
            
            // Generate microplastic events
            for (let i = 0; i < eventCount; i++) {
                // Random event timing and duration
                const startRow = Math.floor(Math.random() * (totalRows * 0.9)); // Start in first 90% of rows
                const duration = Math.floor((totalRows * 0.05) + (Math.random() * totalRows * 0.1)); // 5-15% of total rows
                const endRow = Math.min(startRow + duration, totalRows - 1);
                const peakRow = startRow + Math.floor(duration / 2); // Peak in the middle
                
                // Intensity depends on climate scenario
                let baseIntensity = 0;
                switch (climateScenario) {
                    case 'current':
                        baseIntensity = 0.3 + (Math.random() * 0.2); // 0.3-0.5
                        break;
                    case 'near-future':
                        baseIntensity = 0.4 + (Math.random() * 0.3); // 0.4-0.7
                        break;
                    case 'worst-case':
                        baseIntensity = 0.5 + (Math.random() * 0.5); // 0.5-1.0
                        break;
                }
                
                // Create event object with UK-specific names and descriptions
                const event = {
                    type: 'microplastic',
                    startRow,
                    endRow,
                    peakRow,
                    intensity: baseIntensity,
                    name: `${baseIntensity < 0.4 ? 'Low' : baseIntensity < 0.7 ? 'Moderate' : 'High'} UK Microplastic Event`,
                    description: getUKMicroplasticDescription(baseIntensity, climateScenario)
                };
                
                // Add to events array
                animationState.microplasticEvents.push(event);
            }
            
            // Sort events by start row
            animationState.microplasticEvents.sort((a, b) => a.startRow - b.startRow);
        }

        // Get UK-specific microplastic event description
        function getUKMicroplasticDescription(intensity, climateScenario) {
            let baseDescription = "";
            
            if (intensity < 0.4) {
                baseDescription = "Low-level microplastic contamination from UK coastal waters appears in the shell structure.";
            } else if (intensity < 0.7) {
                baseDescription = "Moderate microplastic pollution from UK rivers and estuaries is incorporated into the shell, creating small abnormalities.";
            } else {
                baseDescription = "Severe microplastic contamination from urban runoff and wastewater causes significant incorporation of particles into shell structure.";
            }
            
            // Add climate scenario context
            if (climateScenario === 'near-future') {
                return `Projected for UK waters by 2050: ${baseDescription}`;
            } else if (climateScenario === 'worst-case') {
                return `In a worst-case scenario for UK marine pollution by 2100: ${baseDescription}`;
            }
            
            return baseDescription;
        }

        // Start a new simulation
        function startNewSimulation() {
            initializeSimulation();
            statusUpdate.textContent = "New growth simulation initialized. Press play to begin.";
        }

        // Toggle play/pause
        function togglePlayPause() {
            animationState.isPlaying = !animationState.isPlaying;
            
            if (animationState.isPlaying) {
                // Start animation
                animationState.startTime = performance.now() - (animationState.currentRow * 50 / animationState.speed);
                animateGrowth();
                playPauseButton.setAttribute('aria-label', 'Pause animation');
            } else {
                // Pause animation
                if (animationState.animationFrameId) {
                    cancelAnimationFrame(animationState.animationFrameId);
                    animationState.animationFrameId = null;
                }
                playPauseButton.setAttribute('aria-label', 'Play animation');
            }
            
            updatePlayPauseButton();
        }

        // Update play/pause button
        function updatePlayPauseButton() {
            if (animationState.isPlaying) {
                playPauseButton.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <rect x="6" y="4" width="4" height="16" fill="currentColor"></rect>
                        <rect x="14" y="4" width="4" height="16" fill="currentColor"></rect>
                    </svg>
                `;
            } else {
                playPauseButton.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon>
                    </svg>
                `;
            }
        }

        // Scrub timeline
        function scrubTimeline() {
            const targetRow = parseInt(timelineSlider.value);
            
            // If we're going backward, we need to reset and redraw up to the target
            if (targetRow < animationState.currentRow) {
                initializePatternGeneration();
                animationState.currentRow = 0;
                previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
                
                // Draw rows up to target
                for (let i = 0; i <= targetRow; i++) {
                    updatePatternBlend(i);
                    drawNextRow();
                }
            } else {
                // Draw any new rows needed to reach target
                while (animationState.currentRow < targetRow) {
                    updatePatternBlend(animationState.currentRow);
                    drawNextRow();
                }
            }
            
            // Update time display
            currentTimeDisplay.textContent = formatTimeDisplay(animationState.currentRow);
            
            // Update growth info for this point in time
            updateGrowthInfo(animationState.currentRow);
            
            // Update environment graph with current time marker
            updateEnvironmentGraph(animationState.currentRow);
            
            // Update age bands
            updateAgeBands(animationState.currentRow);
            
            // Update pattern blend visualization
            updatePatternBlendVisualization(animationState.currentRow);
        }

        // Animate growth
        function animateGrowth() {
            if (!animationState.isPlaying) return;
            
            const now = performance.now();
            const elapsed = now - animationState.startTime;
            const targetRow = Math.min(
                Math.floor(elapsed * animationState.speed / 50), 
                animationState.totalRows
            );
            
            if (targetRow > animationState.currentRow) {
                // Draw new rows
                for (let i = animationState.currentRow; i < targetRow; i++) {
                    updatePatternBlend(i);
                    drawNextRow();
                }
                
                // Update timeline slider
                timelineSlider.value = animationState.currentRow;
                
                // Update time display
                currentTimeDisplay.textContent = formatTimeDisplay(animationState.currentRow);
                
                // Update growth info
                updateGrowthInfo(animationState.currentRow);
                
                // Update environment graph
                updateEnvironmentGraph(animationState.currentRow);
                
                // Update age bands
                updateAgeBands(animationState.currentRow);
                
                // Update pattern blend visualization
                updatePatternBlendVisualization(animationState.currentRow);
            }
            
            // Check if animation is complete
            if (animationState.currentRow >= animationState.totalRows) {
                // Animation complete
                animationState.isPlaying = false;
                updatePlayPauseButton();
                statusUpdate.textContent = "Growth simulation complete. Pattern is ready for fashion application.";
                
                // Generate full resolution image
                generateFullResolutionPattern();
                
                return;
            }
            
            // Continue animation
            animationState.animationFrameId = requestAnimationFrame(animateGrowth);
        }

        // Format time display (convert rows to years and months)
        function formatTimeDisplay(rows) {
            const totalMonths = Math.floor(rows * animationState.monthsPerRow);
            const years = Math.floor(totalMonths / 12);
            const months = totalMonths % 12;
            
            return `${years}y ${months}m`;
        }

        // Initialize pattern blend based on selected pattern type
        function initializePatternBlend() {
            const patternType = patternTypeSelect.value;
            
            // Reset all blend values
            animationState.patternBlend = {
                cellular: 0,
                wave: 0,
                growth: 0,
                voronoi: 0,
                radial: 0
            };
            
            // Set primary pattern type to 100%
            animationState.patternBlend[patternType] = 1;
        }

        // Update pattern blend based on clam age and environmental factors
        function updatePatternBlend(row) {
            const age = row / animationState.totalRows; // Normalized age (0-1)
            const patternBlendingFactor = parseInt(patternBlendingInput.value) / 100; // How much blending occurs (0-1)
            const startingPattern = patternTypeSelect.value; // Initial dominant pattern
            
            // If blending is disabled, keep the initial pattern
            if (patternBlendingFactor === 0) {
                // Reset all blend values
                animationState.patternBlend = {
                    cellular: 0,
                    wave: 0,
                    growth: 0,
                    voronoi: 0,
                    radial: 0
                };
                animationState.patternBlend[startingPattern] = 1;
                return;
            }
            
            // Base pattern evolution for Manila clam shells:
            // - Younger clams favor cellular patterns (rapid growth)
            // - Middle-aged clams favor wave and voronoi patterns (stable growth)
            // - Older clams favor growth rings and radial patterns (slower, more defined growth)
            let cellularWeight = Math.max(0, 1 - (age * 2)); // Dominant when young
            let waveWeight = Math.sin(Math.PI * age); // Peaks in middle age
            let growthWeight = Math.min(1, age * 2); // Increases with age
            let voronoiWeight = Math.sin(Math.PI * age * 0.8) * 0.8; // Peaks in middle-late age
            let radialWeight = Math.min(1, age * 1.6) * 0.7; // Increases gradually with age
            
            // Adjust weights based on starting pattern to make that pattern more prominent
            switch (startingPattern) {
                case 'cellular':
                    cellularWeight *= 1.5;
                    break;
                case 'wave':
                    waveWeight *= 1.5;
                    break;
                case 'growth':
                    growthWeight *= 1.5;
                    break;
                case 'voronoi':
                    voronoiWeight *= 1.5;
                    break;
                case 'radial':
                    radialWeight *= 1.5;
                    break;
            }
            
            // Get current environmental parameters
            const params = getCurrentEnvironmentalParams(row);
            
            // Environmental modifiers - UK-specific
            if (params.temperature > 18) {
                // Stress pattern changes during extreme heat in UK waters - favors cellular (chaotic) growth
                cellularWeight += 0.3;
                growthWeight -= 0.2;
            }
            
            if (params.acidification > 0.5) {
                // Acidification disrupts ordered growth - favors more chaotic patterns
                cellularWeight += 0.2;
                waveWeight -= 0.1;
                growthWeight -= 0.1;
            }
            
            if (params.microplastics > 0.7) {
                // High microplastic contamination affects pattern development
                voronoiWeight += 0.3;
                radialWeight -= 0.2;
            }
            
            // Apply pattern blending factor - smooth transition between states
            cellularWeight = (1 - patternBlendingFactor) * animationState.patternBlend.cellular + patternBlendingFactor * cellularWeight;
            waveWeight = (1 - patternBlendingFactor) * animationState.patternBlend.wave + patternBlendingFactor * waveWeight;
            growthWeight = (1 - patternBlendingFactor) * animationState.patternBlend.growth + patternBlendingFactor * growthWeight;
            voronoiWeight = (1 - patternBlendingFactor) * animationState.patternBlend.voronoi + patternBlendingFactor * voronoiWeight;
            radialWeight = (1 - patternBlendingFactor) * animationState.patternBlend.radial + patternBlendingFactor * radialWeight;
            
            // Normalize weights to sum to 1
            const totalWeight = cellularWeight + waveWeight + growthWeight + voronoiWeight + radialWeight;
            if (totalWeight > 0) {
                cellularWeight /= totalWeight;
                waveWeight /= totalWeight;
                growthWeight /= totalWeight;
                voronoiWeight /= totalWeight;
                radialWeight /= totalWeight;
            } else {
                // Fallback if all weights are zero
                cellularWeight = 1;
                waveWeight = 0;
                growthWeight = 0;
                voronoiWeight = 0;
                radialWeight = 0;
            }
            
            // Update pattern blend
            animationState.patternBlend = {
                cellular: cellularWeight,
                wave: waveWeight,
                growth: growthWeight,
                voronoi: voronoiWeight,
                radial: radialWeight
            };
        }

        // Update pattern blend visualization
        function updatePatternBlendVisualization(row) {
            // Get current pattern blend
            const { cellular, wave, growth, voronoi, radial } = animationState.patternBlend;
            
            // Update bars
            const cellularBar = blendBars.querySelector('.blend-bar.cellular');
            const waveBar = blendBars.querySelector('.blend-bar.wave');
            const growthBar = blendBars.querySelector('.blend-bar.growth');
            const voronoiBar = blendBars.querySelector('.blend-bar.voronoi');
            const radialBar = blendBars.querySelector('.blend-bar.radial');
            
            cellularBar.style.width = `${cellular * 100}%`;
            waveBar.style.width = `${wave * 100}%`;
            growthBar.style.width = `${growth * 100}%`;
            voronoiBar.style.width = `${voronoi * 100}%`;
            radialBar.style.width = `${radial * 100}%`;
            
            // Update labels
            cellularBlendLabel.textContent = `Cellular: ${Math.round(cellular * 100)}%`;
            waveBlendLabel.textContent = `Wave: ${Math.round(wave * 100)}%`;
            growthBlendLabel.textContent = `Growth: ${Math.round(growth * 100)}%`;
            voronoiBlendLabel.textContent = `Voronoi: ${Math.round(voronoi * 100)}%`;
            radialBlendLabel.textContent = `Radial: ${Math
