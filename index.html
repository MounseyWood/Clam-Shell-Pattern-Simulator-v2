<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manila Clam Pattern Generator</title>
    <style>
        :root {
            --ku-black: #1D1D1B;
            --ku-white: #FFFFFF;
            --ku-yellow: #FFF200;
            --ku-navy: #002b49;
            --ku-blue: #009cde;
            --ku-green: #78be20;
            --ku-orange: #e35205;
            --ku-gold: #ffb500;
            --ku-light-blue: #77c5d5;
            --ku-tan: #857550;
            --ku-purple: #9370DB;
        }
        
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: var(--ku-white);
            color: var(--ku-black);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1, h2, h3 {
            color: var(--ku-navy);
        }
        
        header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .banner {
            background-color: var(--ku-navy);
            color: var(--ku-white);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .banner h1 {
            margin: 0;
            color: var(--ku-white);
        }
        
        .banner p {
            margin: 10px 0 0;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .controls {
            flex: 1;
            min-width: 300px;
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .canvas-container {
            flex: 2;
            min-width: 300px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #previewCanvas {
            width: 100%;
            max-width: 600px;
            height: auto;
            aspect-ratio: 1;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .hidden-canvas {
            display: none;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group h3 {
            margin-bottom: 10px;
            border-bottom: 2px solid var(--ku-blue);
            padding-bottom: 5px;
        }
        
        label {
            display: block;
            margin: 12px 0 6px;
            font-weight: 500;
        }
        
        input[type="range"] {
            width: 100%;
            margin-top: 5px;
        }
        
        .value-display {
            display: inline-block;
            width: 50px;
            text-align: right;
            margin-left: 10px;
        }
        
        select, input[type="color"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
        }
        
        button {
            background-color: var(--ku-blue);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s;
            width: 100%;
            margin-top: 5px;
        }
        
        button:hover {
            background-color: var(--ku-navy);
        }
        
        button.secondary {
            background-color: var(--ku-gold);
        }
        
        button.secondary:hover {
            background-color: var(--ku-orange);
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
        }
        
        .tooltip-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 18px;
            height: 18px;
            background-color: var(--ku-light-blue);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: var(--ku-navy);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .color-pickers {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .color-picker {
            flex: 1;
        }

        .color-picker label {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        /* Tab system */
        .tabs {
            width: 100%;
            max-width: 600px;
            margin-top: 15px;
        }

        .tab-buttons {
            display: flex;
            overflow-x: auto;
        }

        .tab-button {
            padding: 8px 15px;
            background-color: #e0e0e0;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            color: #333;
            font-weight: 500;
            margin-right: 2px;
            width: auto;
        }

        .tab-button.active {
            background-color: var(--ku-navy);
            color: white;
        }

        .tab-content {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 0 5px 5px 5px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .tab-panel h3 {
            margin-top: 0;
            color: var(--ku-navy);
        }

        .tab-panel ul {
            padding-left: 20px;
        }

        .tab-panel li {
            margin-bottom: 8px;
        }

        /* UK map styling */
        .uk-map {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 15px auto;
            height: 360px;
            background-color: #f0f8ff;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .uk-region {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: var(--ku-orange);
            transform: translate(-50%, -50%);
        }

        .uk-region::after {
            content: attr(data-name);
            position: absolute;
            white-space: nowrap;
            left: 100%;
            top: 0;
            margin-left: 5px;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .controls, .canvas-container {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="banner">
                <h1>Manila Clam Pattern Generator</h1>
                <p>Create generative designs inspired by Venerupis philippinarum shell patterns found in UK waters</p>
            </div>
        </header>
        
        <main>
            <div class="main-content">
                <div class="controls">
                    <div class="control-group">
                        <h3>Pattern Settings</h3>
                        
                        <label for="patternDensity">Pattern Density
                            <span class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Controls how dense the pattern appears. Higher values create more detailed patterns.</span>
                            </span>
                            <span class="value-display" id="patternDensityValue">50</span>
                        </label>
                        <input type="range" id="patternDensity" min="10" max="100" value="50">
                        
                        <label for="patternVariation">Pattern Variation
                            <span class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Controls how much variation appears in the pattern. Higher values create more organic, varied patterns.</span>
                            </span>
                            <span class="value-display" id="patternVariationValue">50</span>
                        </label>
                        <input type="range" id="patternVariation" min="0" max="100" value="50">
                        
                        <label for="patternSymmetry">Bilateral Symmetry
                            <span class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-text">Controls how symmetrical the pattern is across the central axis.</span>
                            </span>
                            <span class="value-display" id="patternSymmetryValue">60</span>
                        </label>
                        <input type="range" id="patternSymmetry" min="0" max="100" value="60">
                    </div>
                    
                    <div class="control-group">
                        <h3>Environmental Factors</h3>
                        
                        <label for="climateScenario">UK Climate Scenario</label>
                        <select id="climateScenario">
                            <option value="pre-industrial">Pre-Industrial (Stable)</option>
                            <option value="current" selected>Current UK Waters</option>
                            <option value="near-future">Near-Future UK (2050)</option>
                            <option value="worst-case">Worst-Case UK (2100)</option>
                        </select>
                        
                        <label for="temperature">Temperature Effect
                            <span class="value-display" id="temperatureValue">50</span>
                        </label>
                        <input type="range" id="temperature" min="0" max="100" value="50">
                        
                        <label for="waterQuality">Water Quality Impact
                            <span class="value-display" id="waterQualityValue">70</span>
                        </label>
                        <input type="range" id="waterQuality" min="0" max="100" value="70">
                    </div>
                    
                    <div class="control-group">
                        <h3>Colour Settings</h3>
                        
                        <div class="color-pickers">
                            <div class="color-picker">
                                <label for="baseColor">Base</label>
                                <input type="color" id="baseColor" value="#e8d6b3">
                            </div>
                            <div class="color-picker">
                                <label for="accentColor">Accent</label>
                                <input type="color" id="accentColor" value="#6a4c3b">
                            </div>
                            <div class="color-picker">
                                <label for="highlightColor">Highlight</label>
                                <input type="color" id="highlightColor" value="#9370DB">
                            </div>
                        </div>
                        
                        <label for="colorVariation">Colour Variation
                            <span class="value-display" id="colorVariationValue">30</span>
                        </label>
                        <input type="range" id="colorVariation" min="0" max="100" value="30">
                    </div>
                    
                    <div class="action-buttons">
                        <button id="generateButton" type="button">Generate Pattern</button>
                        <button id="downloadButton" type="button" class="secondary">Download for Fashion</button>
                        <button id="resetButton" type="button">Reset Parameters</button>
                    </div>
                </div>
                
                <div class="canvas-container">
                    <canvas id="previewCanvas" width="600" height="600"></canvas>
                    
                    <div class="tabs">
                        <div class="tab-buttons">
                            <button class="tab-button active" data-tab="about">About Manila Clams</button>
                            <button class="tab-button" data-tab="uk">UK Habitats</button>
                            <button class="tab-button" data-tab="climate">Climate Effects</button>
                            <button class="tab-button" data-tab="fashion">Fashion Application</button>
                        </div>
                        
                        <div class="tab-content">
                            <div class="tab-panel about active" id="aboutTab">
                                <h3>About Manila Clam Patterns</h3>
                                <p>The Manila clam (Venerupis philippinarum, also known as Ruditapes philippinarum) creates its shell pattern by depositing calcium carbonate and proteins in layers as it grows. Each new row in the pattern builds upon the previous one, with environmental factors like water temperature, salinity, and food availability influencing the appearance.</p>
                                <p>This generator creates patterns inspired by the natural growth processes of clam shells, simulating how environmental factors influence pattern formation.</p>
                            </div>
                            
                            <div class="tab-panel uk" id="ukTab">
                                <h3>Manila Clams in UK Waters</h3>
                                <p>In the UK, Manila clams were deliberately introduced for aquaculture in the 1980s. They have established wild populations primarily in southern England, particularly in:</p>
                                <ul>
                                    <li><strong>Poole Harbour, Dorset</strong> - Extensive wild populations</li>
                                    <li><strong>Southampton Water</strong> - Established beds</li>
                                    <li><strong>The Solent & Portsmouth Harbour</strong> - Growing populations</li>
                                    <li><strong>Essex & Thames Estuary</strong> - Multiple colonies</li>
                                    <li><strong>Coastal Wales</strong> - Smaller emerging populations</li>
                                </ul>
                                <p>They prefer sheltered estuaries and harbours with sandy/muddy substrates. UK specimens typically grow to 4-6cm in diameter and form shells with distinctive patterning varying from sandy yellow to deep brown with dark zigzag markings.</p>
                            </div>
                            
                            <div class="tab-panel climate" id="climateTab">
                                <h3>Climate Change Effects in UK Waters</h3>
                                <p>Research shows Manila clams in UK waters are affected by climate change:</p>
                                <ul>
                                    <li><strong>Ocean Acidification:</strong> UK coastal waters are experiencing decreasing pH, reducing calcium carbonate availability and resulting in thinner, more irregular shell patterns.</li>
                                    <li><strong>Rising Water Temperatures:</strong> Average UK sea surface temperatures have risen by about 0.8°C since 1980, affecting clam metabolism and growth patterns.</li>
                                    <li><strong>Changing Rainfall Patterns:</strong> More intense rainfall events in the UK alter estuarine salinity levels, creating stress bands in shell growth.</li>
                                    <li><strong>Increased Storm Frequency:</strong> More severe UK winter storms disrupt feeding and growth, visible as interruptions in shell patterning.</li>
                                </ul>
                            </div>
                            
                            <div class="tab-panel fashion" id="fashionTab">
                                <h3>Fashion Application</h3>
                                <p>The patterns generated here can be downloaded and used in fashion design applications. Biomimicry - drawing inspiration from nature's designs - is a powerful approach to sustainable fashion:</p>
                                <ul>
                                    <li><strong>Textile Prints</strong> - Use these organic patterns for fabric designs that celebrate natural forms</li>
                                    <li><strong>Garment Construction</strong> - The concentric growth patterns can inspire layered or paneled garment designs</li>
                                    <li><strong>Color Palettes</strong> - Natural shell gradients provide harmonious color combinations</li>
                                    <li><strong>Sustainable Storytelling</strong> - Connect designs to environmental awareness through nature-inspired patterns</li>
                                </ul>
                                <p>The "Download for Fashion" button provides a high-resolution PNG that can be imported into fashion design software or digital textile printing systems.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <canvas id="hiddenCanvas" class="hidden-canvas" width="4096" height="4096"></canvas>
    
    <script>
        // DOM elements
        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');
        const hiddenCanvas = document.getElementById('hiddenCanvas');
        const hiddenCtx = hiddenCanvas.getContext('2d');
        
        // Control elements
        const generateButton = document.getElementById('generateButton');
        const downloadButton = document.getElementById('downloadButton');
        const resetButton = document.getElementById('resetButton');
        
        // Parameter sliders
        const patternDensity = document.getElementById('patternDensity');
        const patternDensityValue = document.getElementById('patternDensityValue');
        const patternVariation = document.getElementById('patternVariation');
        const patternVariationValue = document.getElementById('patternVariationValue');
        const patternSymmetry = document.getElementById('patternSymmetry');
        const patternSymmetryValue = document.getElementById('patternSymmetryValue');
        const temperature = document.getElementById('temperature');
        const temperatureValue = document.getElementById('temperatureValue');
        const waterQuality = document.getElementById('waterQuality');
        const waterQualityValue = document.getElementById('waterQualityValue');
        const colorVariation = document.getElementById('colorVariation');
        const colorVariationValue = document.getElementById('colorVariationValue');
        
        // Color pickers
        const baseColor = document.getElementById('baseColor');
        const accentColor = document.getElementById('accentColor');
        const highlightColor = document.getElementById('highlightColor');
        
        // Climate scenario
        const climateScenario = document.getElementById('climateScenario');
        
        // Tab system
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanels = document.querySelectorAll('.tab-panel');
        
        // Pattern generation parameters
        let params = {
            density: 50,
            variation: 50,
            symmetry: 60,
            temperature: 50,
            waterQuality: 70,
            colorVariation: 30,
            baseColor: '#e8d6b3',
            accentColor: '#6a4c3b',
            highlightColor: '#9370DB',
            climate: 'current'
        };
        
        // Add UK map to UK Habitats tab
        function initUKMap() {
            const ukTab = document.getElementById('ukTab');
            if (ukTab) {
                // Create map container
                const mapContainer = document.createElement('div');
                mapContainer.className = 'uk-map';
                
                // Add UK regions where Manila clams are found
                const regions = [
                    { name: 'Poole Harbour', x: 150, y: 280 },
                    { name: 'Southampton Water', x: 160, y: 260 },
                    { name: 'Portsmouth', x: 170, y: 270 },
                    { name: 'Essex', x: 205, y: 210 },
                    { name: 'Thames Estuary', x: 215, y: 220 },
                    { name: 'North Wales', x: 120, y: 180 }
                ];
                
                regions.forEach(region => {
                    const dot = document.createElement('div');
                    dot.className = 'uk-region';
                    dot.style.left = `${region.x}px`;
                    dot.style.top = `${region.y}px`;
                    dot.setAttribute('data-name', region.name);
                    mapContainer.appendChild(dot);
                });
                
                // Add map outline
                const mapOutline = document.createElement('div');
                mapOutline.style.position = 'absolute';
                mapOutline.style.width = '100%';
                mapOutline.style.height = '100%';
                mapOutline.style.backgroundImage = 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 300 360\'%3E%3Cpath d=\'M120,30 C100,70 90,100 120,150 C150,200 140,250 100,300 C200,330 250,280 270,200 C290,120 230,80 200,50 C170,20 140,10 120,30 Z\' fill=\'none\' stroke=\'%23666\' stroke-width=\'2\'/%3E%3C/svg%3E")';
                mapOutline.style.backgroundSize = 'contain';
                mapOutline.style.backgroundRepeat = 'no-repeat';
                mapOutline.style.backgroundPosition = 'center';
                mapContainer.appendChild(mapOutline);
                
                // Add map to the UK tab after the first paragraph
                const firstP = ukTab.querySelector('p');
                if (firstP) {
                    firstP.after(mapContainer);
                } else {
                    ukTab.appendChild(mapContainer);
                }
                
                // Add caption
                const caption = document.createElement('p');
                caption.style.textAlign = 'center';
                caption.style.fontSize = '12px';
                caption.style.fontStyle = 'italic';
                caption.innerText = 'Main locations of Manila clam populations in UK waters';
                mapContainer.after(caption);
            }
        }
        
        // Event listeners for sliders to update displayed values
        patternDensity.addEventListener('input', () => {
            patternDensityValue.textContent = patternDensity.value;
            params.density = parseInt(patternDensity.value);
        });
        
        patternVariation.addEventListener('input', () => {
            patternVariationValue.textContent = patternVariation.value;
            params.variation = parseInt(patternVariation.value);
        });
        
        patternSymmetry.addEventListener('input', () => {
            patternSymmetryValue.textContent = patternSymmetry.value;
            params.symmetry = parseInt(patternSymmetry.value);
        });
        
        temperature.addEventListener('input', () => {
            temperatureValue.textContent = temperature.value;
            params.temperature = parseInt(temperature.value);
        });
        
        waterQuality.addEventListener('input', () => {
            waterQualityValue.textContent = waterQuality.value;
            params.waterQuality = parseInt(waterQuality.value);
        });
        
        colorVariation.addEventListener('input', () => {
            colorVariationValue.textContent = colorVariation.value;
            params.colorVariation = parseInt(colorVariation.value);
        });
        
        // Color picker change events
        baseColor.addEventListener('input', () => {
            params.baseColor = baseColor.value;
        });
        
        accentColor.addEventListener('input', () => {
            params.accentColor = accentColor.value;
        });
        
        highlightColor.addEventListener('input', () => {
            params.highlightColor = highlightColor.value;
        });
        
        // Climate scenario change
        climateScenario.addEventListener('change', () => {
            params.climate = climateScenario.value;
            updateClimateParameters();
        });
        
        // Generate pattern button
        generateButton.addEventListener('click', () => {
            generatePattern();
        });
        
        // Download button
        downloadButton.addEventListener('click', () => {
            downloadPattern();
        });
        
        // Reset button
        resetButton.addEventListener('click', () => {
            resetParameters();
        });
        
        // Tab system
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabPanels.forEach(panel => panel.classList.remove('active'));
                
                button.classList.add('active');
                
                const tabId = button.getAttribute('data-tab');
                document.getElementById(`${tabId}Tab`).classList.add('active');
            });
        });
        
        // Update climate parameters based on selected scenario
        function updateClimateParameters() {
            switch (params.climate) {
                case 'pre-industrial':
                    waterQuality.value = 90;
                    waterQualityValue.textContent = 90;
                    params.waterQuality = 90;
                    temperature.value = 35;
                    temperatureValue.textContent = 35;
                    params.temperature = 35;
                    break;
                case 'current':
                    waterQuality.value = 70;
                    waterQualityValue.textContent = 70;
                    params.waterQuality = 70;
                    temperature.value = 50;
                    temperatureValue.textContent = 50;
                    params.temperature = 50;
                    break;
                case 'near-future':
                    waterQuality.value = 40;
                    waterQualityValue.textContent = 40;
                    params.waterQuality = 40;
                    temperature.value = 65;
                    temperatureValue.textContent = 65;
                    params.temperature = 65;
                    break;
                case 'worst-case':
                    waterQuality.value = 20;
                    waterQualityValue.textContent = 20;
                    params.waterQuality = 20;
                    temperature.value = 80;
                    temperatureValue.textContent = 80;
                    params.temperature = 80;
                    break;
            }
        }
        
        // Reset all parameters to defaults
        function resetParameters() {
            patternDensity.value = 50;
            patternDensityValue.textContent = 50;
            params.density = 50;
            
            patternVariation.value = 50;
            patternVariationValue.textContent = 50;
            params.variation = 50;
            
            patternSymmetry.value = 60;
            patternSymmetryValue.textContent = 60;
            params.symmetry = 60;
            
            climateScenario.value = 'current';
            params.climate = 'current';
            
            temperature.value = 50;
            temperatureValue.textContent = 50;
            params.temperature = 50;
            
            waterQuality.value = 70;
            waterQualityValue.textContent = 70;
            params.waterQuality = 70;
            
            colorVariation.value = 30;
            colorVariationValue.textContent = 30;
            params.colorVariation = 30;
            
            baseColor.value = '#e8d6b3';
            params.baseColor = '#e8d6b3';
            
            accentColor.value = '#6a4c3b';
            params.accentColor = '#6a4c3b';
            
            highlightColor.value = '#9370DB';
            params.highlightColor = '#9370DB';
            
            generatePattern();
        }
        
        // Convert hex to RGB
        function hexToRgb(hex) {
            const r = parseInt(hex.substring(1, 3), 16);
            const g = parseInt(hex.substring(3, 5), 16);
            const b = parseInt(hex.substring(5, 7), 16);
            return { r, g, b };
        }
        
        // Simple noise function (Perlin-like)
        function noise(x, y, seed = 0) {
            return Math.sin(x * 0.01 + seed) * Math.cos(y * 0.01 + seed) * 0.5 +
                   Math.sin(x * 0.05 + seed * 2) * Math.cos(y * 0.05 + seed * 3) * 0.25 +
                   Math.sin(x * 0.1 + seed * 4) * Math.cos(y * 0.1 + seed * 5) * 0.125;
        }
        
        // Generate the shell pattern
        function generatePattern() {
            const width = previewCanvas.width;
            const height = previewCanvas.height;
            
            // Clear the canvas
            previewCtx.clearRect(0, 0, width, height);
            
            // Get RGB values for colors
            const baseRgb = hexToRgb(params.baseColor);
            const accentRgb = hexToRgb(params.accentColor);
            const highlightRgb = hexToRgb(params.highlightColor);
            
            // Parameters affecting pattern
            const density = params.density / 10; // Scale density
            const variation = params.variation / 100; // Keep as 0-1 range
            const symmetry = params.symmetry / 100; // Keep as 0-1 range
            const temperature = params.temperature / 100; // Keep as 0-1 range
            const waterQuality = params.waterQuality / 100; // Keep as 0-1 range
            const colorVar = params.colorVariation / 100; // Keep as 0-1 range
            
            // Create image data object
            const imageData = previewCtx.createImageData(width, height);
            const data = imageData.data;
            
            // Climate effects
            let climateNoise = 0;
            let acidification = 0;
            let microplastics = 0;
            
            switch (params.climate) {
                case 'pre-industrial':
                    climateNoise = 0.1;
                    acidification = 0;
                    microplastics = 0;
                    break;
                case 'current':
                    climateNoise = 0.2;
                    acidification = 0.2;
                    microplastics = 0.15;
                    break;
                case 'near-future':
                    climateNoise = 0.4;
                    acidification = 0.5;
                    microplastics = 0.4;
                    break;
                case 'worst-case':
                    climateNoise = 0.7;
                    acidification = 0.8;
                    microplastics = 0.7;
                    break;
            }
            
            // Generate pattern
            const centerX = width / 2;
            const centerY = height / 2;
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const index = (y * width + x) * 4;
                    
                    // Apply symmetry if needed
                    let effectiveX = x;
                    if (Math.random() < symmetry && x > centerX) {
                        effectiveX = width - x; // Mirror across vertical axis
                    }
                    
                    // Distance from center (normalized)
                    const dx = (effectiveX - centerX) / (width / 2);
                    const dy = (y - centerY) / (height / 2);
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // Angle from center
                    const angle = Math.atan2(dy, dx);
                    
                    // Pattern elements
                    
                    // 1. Radial growth rings - affected by temperature
                    const rings = Math.sin(distance * density * (1 + temperature * 0.5) * Math.PI * 2) * 0.5 + 0.5;
                    
                    // 2. Wave patterns - affected by water quality
                    const waves = Math.sin(angle * 10 + distance * 15 * waterQuality) * 0.5 + 0.5;
                    
                    // 3. Noise texture - affected by variation
                    const noiseValue = (noise(effectiveX, y, 0) * 0.5 + 0.5) * variation;
                    
                    // 4. Climate effects
                    const climateEffect = noise(effectiveX * 5, y * 5, 10) * climateNoise;
                    
                    // 5. Acidification (creates holes/gaps in pattern)
                    let acidEffect = 0;
                    if (acidification > 0 && noise(effectiveX * 2, y * 2, 20) > 0.5) {
                        acidEffect = acidification * 0.7;
                    }
                    
                    // Combine pattern elements - the main pattern algorithm
                    let patternValue = rings * 0.5 + waves * 0.3 + noiseValue * 0.2;
                    
                    // Apply climate effects
                    patternValue = patternValue * (1 - climateEffect) - acidEffect;
                    
                    // Add color variation
                    const randomVariation = (Math.random() - 0.5) * colorVar * 0.4;
                    patternValue = Math.max(0, Math.min(1, patternValue + randomVariation));
                    
                    // Interpolate colors based on pattern value
                    let r, g, b;
                    
                    // Base case - interpolate between base and accent colors
                    r = Math.floor(baseRgb.r * (1 - patternValue) + accentRgb.r * patternValue);
                    g = Math.floor(baseRgb.g * (1 - patternValue) + accentRgb.g * patternValue);
                    b = Math.floor(baseRgb.b * (1 - patternValue) + accentRgb.b * patternValue);
                    
                    // Add microplastic speckles
                    if (microplastics > 0 && Math.random() < microplastics * 0.05) {
                        r = Math.floor(r * 0.3 + highlightRgb.r * 0.7);
                        g = Math.floor(g * 0.3 + highlightRgb.g * 0.7);
                        b = Math.floor(b * 0.3 + highlightRgb.b * 0.7);
                    }
                    
                    // Set pixel color
                    data[index] = r;
                    data[index + 1] = g;
                    data[index + 2] = b;
                    data[index + 3] = 255; // Fully opaque
                }
            }
            
            // Put the image data onto the canvas
            previewCtx.putImageData(imageData, 0, 0);
            
            // Generate high-res version
            generateHighRes();
        }
        
        // Generate high-resolution version for download
        function generateHighRes() {
            const width = hiddenCanvas.width;
            const height = hiddenCanvas.height;
            
            // Draw the preview canvas onto the hidden canvas with scaling
            hiddenCtx.drawImage(
                previewCanvas,
                0, 0, previewCanvas.width, previewCanvas.height,
                0, 0, width, height
            );
        }
        
        // Download the pattern
        function downloadPattern() {
            const link = document.createElement('a');
            
            // Set climate-specific filename
            const climateNames = {
                'pre-industrial': 'preindustrial',
                'current': 'current',
                'near-future': 'future2050',
                'worst-case': 'scenario2100'
            };
            
            const filename = `manila-clam-pattern-${climateNames[params.climate]}.png`;
            link.download = filename;
            
            // Get image data from hidden canvas
            link.href = hiddenCanvas.toDataURL('image/png');
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize UK map
            initUKMap();
            
            // Generate initial pattern
            generatePattern();
        });
    </script>
</body>
</html>
